// 📁 app.js - ПОЛНЫЙ ПЕРЕНОС LIFE WHEEL В REACT
console.log("🚀 Opening Horizons - ПОЛНЫЙ ПЕРЕНОС LIFE WHEEL В REACT");

// 🎯 МЕНЕДЖЕР ДАННЫХ
class ExtendedUnifiedDataManager {
  constructor() {
    console.log("🔄 ExtendedUnifiedDataManager создан");
  }

  loadAllData() {
    const data = {
      tasks: this.loadTasks(),
      goals: this.loadGoals(),
      reflections: this.loadReflections(),
      settings: this.loadSettings(),
    };
    return data;
  }

  loadGoals() {
    try {
      const saved = localStorage.getItem("life-wheel-goals");
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error("❌ Ошибка загрузки целей:", error);
      return [];
    }
  }

  saveGoals(goals) {
    try {
      localStorage.setItem("life-wheel-goals", JSON.stringify(goals));
    } catch (error) {
      console.error("❌ Ошибка сохранения целей:", error);
    }
  }

  loadReflections() {
    try {
      const saved = localStorage.getItem("life-wheel-reflections");
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error("❌ Ошибка загрузки анализов:", error);
      return [];
    }
  }

  saveReflections(reflections) {
    try {
      localStorage.setItem(
        "life-wheel-reflections",
        JSON.stringify(reflections)
      );
    } catch (error) {
      console.error("❌ Ошибка сохранения анализов:", error);
    }
  }

  loadSettings() {
    try {
      const saved = localStorage.getItem("life-wheel-settings");
      const defaultSettings = {
        archetype: "balanced",
        darkTheme: false,
        notifications: true,
        autoSave: true,
        colorScheme: "purple",
      };
      return saved
        ? { ...defaultSettings, ...JSON.parse(saved) }
        : defaultSettings;
    } catch (error) {
      console.error("❌ Ошибка загрузки настроек:", error);
      return { archetype: "balanced" };
    }
  }

  saveSettings(settings) {
    try {
      localStorage.setItem("life-wheel-settings", JSON.stringify(settings));
    } catch (error) {
      console.error("❌ Ошибка сохранения настроек:", error);
    }
  }

  updateArchetype(archetype) {
    const settings = this.loadSettings();
    settings.archetype = archetype;
    this.saveSettings(settings);
  }

  loadLifeWheelTasks() {
    try {
      const saved = localStorage.getItem("life-wheel-tasks");
      return saved ? JSON.parse(saved) : [];
    } catch (error) {
      console.error("❌ Ошибка загрузки задач:", error);
      return [];
    }
  }

  saveLifeWheelTasks(tasks) {
    try {
      localStorage.setItem("life-wheel-tasks", JSON.stringify(tasks));
    } catch (error) {
      console.error("❌ Ошибка сохранения задач:", error);
    }
  }

  loadTasks() {
    return this.loadLifeWheelTasks();
  }

  saveTasks(tasks) {
    this.saveLifeWheelTasks(tasks);
  }
}

// 🍅 POMODORO ТАЙМЕР
class PomodoroTimer {
  constructor() {
    this.isRunning = false;
    this.timeLeft = 25 * 60;
    this.currentMode = "work";
    this.interval = null;
  }

  start() {
    if (!this.isRunning) {
      this.isRunning = true;
      this.interval = setInterval(() => {
        this.timeLeft--;
        this.updateDisplay();
        if (this.timeLeft <= 0) {
          this.completeSession();
        }
      }, 1000);
    }
  }

  pause() {
    this.isRunning = false;
    if (this.interval) clearInterval(this.interval);
  }

  reset() {
    this.pause();
    this.timeLeft = this.currentMode === "work" ? 25 * 60 : 5 * 60;
    this.updateDisplay();
  }

  switchMode(mode) {
    this.pause();
    this.currentMode = mode;
    this.timeLeft = mode === "work" ? 25 * 60 : 5 * 60;
    this.updateDisplay();
  }

  completeSession() {
    this.pause();
    alert(
      `🎉 ${
        this.currentMode === "work" ? "Рабочая сессия" : "Перерыв"
      } завершена!`
    );
    this.switchMode(this.currentMode === "work" ? "break" : "work");
  }

  updateDisplay() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    const display = document.getElementById("pomodoro-display");
    if (display) {
      display.textContent = `${minutes.toString().padStart(2, "0")}:${seconds
        .toString()
        .padStart(2, "0")}`;
    }
  }

  getDisplayTime() {
    const minutes = Math.floor(this.timeLeft / 60);
    const seconds = this.timeLeft % 60;
    return `${minutes.toString().padStart(2, "0")}:${seconds
      .toString()
      .padStart(2, "0")}`;
  }
}

// 🎯 ОСНОВНОЕ ПРИЛОЖЕНИЕ - ПОЛНЫЙ LIFE WHEEL
class ReactLifeWheelApp {
  constructor() {
    console.log("⚛️ ReactLifeWheelApp создан - ПОЛНАЯ ВЕРСИЯ LIFE WHEEL");
    this.dataManager = new ExtendedUnifiedDataManager();
    this.pomodoro = new PomodoroTimer();
    this.currentTab = "planning";
    this.currentGoalId = null;
    this.init();
  }

  init() {
    this.renderFullLifeWheel();
    this.setupFullEventListeners();
  }

  renderFullLifeWheel() {
    const root = document.getElementById("root");
    if (!root) {
      console.error("❌ Root element not found!");
      return;
    }

    const data = this.dataManager.loadAllData();
    const lifeWheelTasks = this.dataManager.loadLifeWheelTasks();

    root.innerHTML = `
      <div class="life-wheel-app">
        <header class="life-wheel-header">
          <div class="header-main">
            <h1>🎯 Колесо Жизни</h1>
            <p class="subtitle">Баланс, планирование и рефлексия для гармоничной жизни</p>
          </div>
          
          <div class="pomodoro-section">
            <div class="pomodoro-widget">
              <div class="pomodoro-header">
                <span>🍅 ${
                  this.pomodoro.currentMode === "work" ? "Работа" : "Перерыв"
                }</span>
                <div class="time-display" id="pomodoro-display">${this.pomodoro.getDisplayTime()}</div>
              </div>
              <div class="pomodoro-controls">
                <button class="pomo-btn" id="pomodoro-start">▶️</button>
                <button class="pomo-btn" id="pomodoro-pause">⏸️</button>
                <button class="pomo-btn" id="pomodoro-reset">🔄</button>
                <button class="pomo-btn" id="pomodoro-switch">⚡</button>
              </div>
            </div>
          </div>
        </header>
        
        <div class="nav-tabs">
          <button class="tab-btn ${
            this.currentTab === "planning" ? "active" : ""
          }" data-tab="planning">
            <span>📅</span> Планирование Дня
          </button>
          <button class="tab-btn ${
            this.currentTab === "goals" ? "active" : ""
          }" data-tab="goals">
            <span>🎯</span> Цели
          </button>
          <button class="tab-btn ${
            this.currentTab === "reflection" ? "active" : ""
          }" data-tab="reflection">
            <span>🌙</span> Вечерний Анализ
          </button>
          <button class="tab-btn ${
            this.currentTab === "settings" ? "active" : ""
          }" data-tab="settings">
            <span>⚙️</span> Настройки
          </button>
        </div>
        
        <!-- 📅 ПЛАНИРОВАНИЕ ДНЯ -->
        <div class="tab-content ${
          this.currentTab === "planning" ? "active" : ""
        }" id="planning">
          <h2 class="section-title">Планирование Дня</h2>
          
          <div class="archetype-section">
            <h3>Выберите тип дня</h3>
            <p>Выберите архетип, который лучше всего соответствует вашему состоянию и задачам на сегодня</p>
            
            <div class="archetype-selector">
              <div class="archetype-option ${
                data.settings.archetype === "productive" ? "active" : ""
              }" data-archetype="productive">
                <span class="archetype-icon">📈</span>
                <div class="archetype-name">ПРОДУКТИВНЫЙ</div>
                <div class="archetype-desc">Сфокусируйтесь на важных задачах и достижении целей</div>
              </div>
              <div class="archetype-option ${
                data.settings.archetype === "balanced" ? "active" : ""
              }" data-archetype="balanced">
                <span class="archetype-icon">⚖️</span>
                <div class="archetype-name">СБАЛАНСИРОВАННЫЙ</div>
                <div class="archetype-desc">Равномерное распределение энергии между работой, отдыхом и личными делами</div>
              </div>
              <div class="archetype-option ${
                data.settings.archetype === "recovery" ? "active" : ""
              }" data-archetype="recovery">
                <span class="archetype-icon">🔄</span>
                <div class="archetype-name">ВОССТАНАВЛИВАЮЩИЙ</div>
                <div class="archetype-desc">День для отдыха, восстановления сил и заботы о себе</div>
              </div>
            </div>
          </div>
          
          <div class="task-form">
            <input type="text" class="task-input" id="taskInput" placeholder="Опишите вашу задачу...">
            <button class="btn" id="addTaskBtn">
              <span>➕</span> Добавить
            </button>
          </div>
          
          <div class="task-options">
            <div class="option-group">
              <div class="option-label">Сфера жизни</div>
              <select class="option-select" id="taskSphere">
                <option value="health">Здоровье</option>
                <option value="career">Карьера</option>
                <option value="family">Семья</option>
                <option value="finance">Финансы</option>
                <option value="development">Развитие</option>
                <option value="hobby">Хобби</option>
              </select>
            </div>
            
            <div class="option-group">
              <div class="option-label">Время выполнения</div>
              <div class="time-input-group">
                <input type="text" class="time-input" id="startTime" placeholder="09:00" maxlength="5">
                <span class="time-separator">—</span>
                <input type="text" class="time-input" id="endTime" placeholder="10:30" maxlength="5">
              </div>
            </div>
          </div>
          
          <div class="date-selector">
            <label for="taskDate">Дата выполнения:</label>
            <input type="date" class="date-input" id="taskDate" value="${
              new Date().toISOString().split("T")[0]
            }">
          </div>
          
          <div class="tasks-categories">
            <div class="tasks-category">
              <h3>📋 Задачи на сегодня</h3>
              <div class="task-list" id="todayTasks">
                ${this.renderTasksByCategory(lifeWheelTasks, "today")}
              </div>
            </div>
            
            <div class="tasks-category">
              <h3>📅 Будущие задачи</h3>
              <div class="task-list" id="futureTasks">
                ${this.renderTasksByCategory(lifeWheelTasks, "future")}
              </div>
            </div>
          </div>
        </div>
        
        <!-- 🎯 ЦЕЛИ -->
        <div class="tab-content ${
          this.currentTab === "goals" ? "active" : ""
        }" id="goals">
          <h2 class="section-title">Мои Цели</h2>
          
          <div class="goals-container" id="goalsList">
            ${this.renderGoals(data.goals)}
          </div>
          
          <div style="margin-top: 30px;">
            <h3>Добавить новую цель</h3>
            <div class="task-form">
              <input type="text" class="task-input" id="goalInput" placeholder="Опишите вашу цель...">
              <button class="btn" id="addGoalBtn">
                <span>🎯</span> Добавить цель
              </button>
            </div>
          </div>
        </div>
        
        <!-- 🌙 ВЕЧЕРНИЙ АНАЛИЗ -->
        <div class="tab-content ${
          this.currentTab === "reflection" ? "active" : ""
        }" id="reflection">
          <h2 class="section-title">Вечерний Анализ</h2>
          
          <div class="reflection-questions">
            <div class="question-item">
              <div class="question-text">1. Что получилось особенно хорошо сегодня?</div>
              <textarea class="answer-input" id="question1"></textarea>
            </div>
            
            <div class="question-item">
              <div class="question-text">2. Что бы я сделал иначе, если бы мог вернуться назад?</div>
              <textarea class="answer-input" id="question2"></textarea>
            </div>
            
            <div class="question-item">
              <div class="question-text">3. Какие уроки я извлек из сегодняшнего дня?</div>
              <textarea class="answer-input" id="question3"></textarea>
            </div>
          </div>
          
          <button class="btn" id="saveReflectionBtn">
            <span>💾</span> Сохранить анализ
          </button>
          
          <div style="margin-top: 40px;">
            <h3>📊 История анализов</h3>
            <div id="reflectionsHistory">
              ${this.renderReflectionsHistory(data.reflections)}
            </div>
          </div>
        </div>
        
        <!-- ⚙️ НАСТРОЙКИ -->
        <div class="tab-content ${
          this.currentTab === "settings" ? "active" : ""
        }" id="settings">
          <h2 class="section-title">Настройки</h2>
          
          <div class="settings-container">
            <div class="settings-card">
              <div class="settings-title">Внешний вид</div>
              
              <div class="settings-option">
                <div class="settings-label">Темная тема</div>
                <label class="toggle">
                  <input type="checkbox" id="darkTheme" ${
                    data.settings.darkTheme ? "checked" : ""
                  }>
                  <span class="slider"></span>
                </label>
              </div>
              
              <div class="settings-option">
                <div class="settings-label">Уведомления</div>
                <label class="toggle">
                  <input type="checkbox" id="notifications" ${
                    data.settings.notifications ? "checked" : ""
                  }>
                  <span class="slider"></span>
                </label>
              </div>
            </div>
            
            <div class="settings-card">
              <div class="settings-title">Управление данными</div>
              
              <div class="settings-option">
                <div class="settings-label">Экспорт данных</div>
                <button class="btn btn-outline" id="exportData">
                  <span>📤</span> Экспорт
                </button>
              </div>
              
              <div class="settings-option">
                <div class="settings-label">Импорт данных</div>
                <button class="btn btn-outline" id="importData">
                  <span>📥</span> Импорт
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;

    this.pomodoro.updateDisplay();
  }

  setupFullEventListeners() {
    // Навигация
    document.querySelectorAll(".tab-btn").forEach((button) => {
      button.addEventListener("click", (e) => {
        const tabId = e.target.dataset.tab;
        this.switchTab(tabId);
      });
    });

    // Архетипы
    document.querySelectorAll(".archetype-option").forEach((option) => {
      option.addEventListener("click", (e) => {
        const archetype =
          e.target.closest(".archetype-option").dataset.archetype;
        this.selectArchetype(archetype);
      });
    });

    // Задачи
    document.getElementById("addTaskBtn")?.addEventListener("click", () => {
      this.addTask();
    });

    // Цели
    document.getElementById("addGoalBtn")?.addEventListener("click", () => {
      this.addGoal();
    });

    // Анализ
    document
      .getElementById("saveReflectionBtn")
      ?.addEventListener("click", () => {
        this.saveReflection();
      });

    // Pomodoro
    document
      .getElementById("pomodoro-start")
      ?.addEventListener("click", () => this.pomodoro.start());
    document
      .getElementById("pomodoro-pause")
      ?.addEventListener("click", () => this.pomodoro.pause());
    document
      .getElementById("pomodoro-reset")
      ?.addEventListener("click", () => this.pomodoro.reset());
    document
      .getElementById("pomodoro-switch")
      ?.addEventListener("click", () =>
        this.pomodoro.switchMode(
          this.pomodoro.currentMode === "work" ? "break" : "work"
        )
      );

    // Делегирование
    this.setupEventDelegation();
    this.setupTimeFormatting();
  }

  setupEventDelegation() {
    document.addEventListener("change", (e) => {
      if (e.target.classList.contains("task-checkbox")) {
        this.toggleTaskCompletion(e.target);
      }
    });

    document.addEventListener("click", (e) => {
      if (e.target.classList.contains("delete-task-btn")) {
        this.deleteTask(e.target.closest(".task-item"));
      }
    });
  }

  setupTimeFormatting() {
    document.getElementById("startTime")?.addEventListener("input", (e) => {
      let value = e.target.value.replace(/\D/g, "");
      if (value.length >= 2) {
        value = value.substring(0, 2) + ":" + value.substring(2, 4);
      }
      e.target.value = value;
    });

    document.getElementById("endTime")?.addEventListener("input", (e) => {
      let value = e.target.value.replace(/\D/g, "");
      if (value.length >= 2) {
        value = value.substring(0, 2) + ":" + value.substring(2, 4);
      }
      e.target.value = value;
    });
  }

  // 📝 ОСНОВНЫЕ МЕТОДЫ
  switchTab(tab) {
    this.currentTab = tab;
    this.renderFullLifeWheel();
  }

  selectArchetype(archetype) {
    this.dataManager.updateArchetype(archetype);
    this.renderFullLifeWheel();
  }

  renderTasksByCategory(tasks, category) {
    const today = new Date().toISOString().split("T")[0];
    let filteredTasks = [];

    switch (category) {
      case "today":
        filteredTasks = tasks.filter(
          (task) => task.date === today && !task.completed
        );
        break;
      case "future":
        filteredTasks = tasks.filter(
          (task) => task.date && task.date > today && !task.completed
        );
        break;
    }

    if (filteredTasks.length === 0) {
      return '<p style="text-align: center; padding: 20px; color: #696969;">Задачи отсутствуют</p>';
    }

    return filteredTasks
      .map(
        (task) => `
      <div class="task-item ${
        task.completed ? "completed" : ""
      }" data-task-id="${task.id}">
        <input type="checkbox" class="task-checkbox" ${
          task.completed ? "checked" : ""
        }>
        <div class="task-content">
          <div class="task-text">${task.text}</div>
          <div class="task-meta">
            ${
              task.startTime && task.endTime
                ? `<div class="task-time">${task.startTime} - ${task.endTime}</div>`
                : ""
            }
            ${
              task.sphere
                ? `<div class="task-sphere">${this.getSphereName(
                    task.sphere
                  )}</div>`
                : ""
            }
          </div>
        </div>
        <button class="action-btn delete-task-btn">🗑️</button>
      </div>
    `
      )
      .join("");
  }

  getSphereName(sphere) {
    const spheres = {
      health: "Здоровье",
      career: "Карьера",
      family: "Семья",
      finance: "Финансы",
      development: "Развитие",
      hobby: "Хобби",
    };
    return spheres[sphere] || sphere;
  }

  validateTime(time) {
    const timeRegex = /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/;
    return timeRegex.test(time);
  }

  addTask() {
    const taskInput = document.getElementById("taskInput");
    const taskText = taskInput.value.trim();

    if (!taskText) {
      alert("Введите текст задачи!");
      return;
    }

    const taskSphere = document.getElementById("taskSphere").value;
    const startTime = document.getElementById("startTime").value;
    const endTime = document.getElementById("endTime").value;
    const taskDate = document.getElementById("taskDate").value;

    if (startTime && !this.validateTime(startTime)) {
      alert("Пожалуйста, введите корректное время начала в формате ЧЧ:MM");
      return;
    }

    if (endTime && !this.validateTime(endTime)) {
      alert("Пожалуйста, введите корректное время окончания в формате ЧЧ:MM");
      return;
    }

    const tasks = this.dataManager.loadLifeWheelTasks();
    const newTask = {
      id: Date.now(),
      text: taskText,
      sphere: taskSphere,
      startTime: startTime,
      endTime: endTime,
      date: taskDate,
      completed: false,
      createdAt: new Date().toISOString(),
    };

    tasks.push(newTask);
    this.dataManager.saveLifeWheelTasks(tasks);

    taskInput.value = "";
    document.getElementById("startTime").value = "";
    document.getElementById("endTime").value = "";

    this.renderFullLifeWheel();
    alert("✅ Задача добавлена!");
  }

  toggleTaskCompletion(checkbox) {
    const taskItem = checkbox.closest(".task-item");
    const taskId = parseInt(taskItem.dataset.taskId);

    const tasks = this.dataManager.loadLifeWheelTasks();
    const taskIndex = tasks.findIndex((t) => t.id === taskId);

    if (taskIndex !== -1) {
      tasks[taskIndex].completed = checkbox.checked;
      this.dataManager.saveLifeWheelTasks(tasks);

      if (checkbox.checked) {
        taskItem.classList.add("completed");
      } else {
        taskItem.classList.remove("completed");
      }
    }
  }

  deleteTask(taskElement) {
    const taskId = parseInt(taskElement.dataset.taskId);

    if (confirm("Удалить эту задачу?")) {
      const tasks = this.dataManager.loadLifeWheelTasks();
      const updatedTasks = tasks.filter((t) => t.id !== taskId);
      this.dataManager.saveLifeWheelTasks(updatedTasks);
      taskElement.remove();
    }
  }

  renderGoals(goals) {
    if (goals.length === 0) {
      return '<p style="text-align: center; padding: 30px; color: #696969;">Цели еще не добавлены</p>';
    }

    return goals
      .map((goal) => {
        const completedSteps = goal.steps
          ? goal.steps.filter((step) => step.completed).length
          : 0;
        const totalSteps = goal.steps ? goal.steps.length : 0;
        const progress =
          totalSteps > 0 ? (completedSteps / totalSteps) * 100 : 0;

        return `
        <div class="goal-card" data-goal-id="${goal.id}">
          <div class="goal-title">${goal.text}</div>
          <div class="goal-progress">
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${progress}%"></div>
            </div>
            <div class="progress-text">${completedSteps} из ${totalSteps} шагов</div>
          </div>
        </div>
      `;
      })
      .join("");
  }

  addGoal() {
    const input = document.getElementById("goalInput");
    const text = input.value.trim();

    if (text) {
      const goals = this.dataManager.loadGoals();
      goals.push({
        id: Date.now(),
        text: text,
        steps: [],
        createdAt: new Date().toISOString(),
      });
      this.dataManager.saveGoals(goals);
      input.value = "";
      this.renderFullLifeWheel();
      alert("✅ Цель добавлена!");
    } else {
      alert("Введите текст цели!");
    }
  }

  saveReflection() {
    const reflections = this.dataManager.loadReflections();
    const settings = this.dataManager.loadSettings();

    const reflection = {
      id: Date.now(),
      date: new Date().toISOString().split("T")[0],
      question1: document.getElementById("question1").value,
      question2: document.getElementById("question2").value,
      question3: document.getElementById("question3").value,
      archetype: settings.archetype,
      createdAt: new Date().toISOString(),
    };

    reflections.push(reflection);
    this.dataManager.saveReflections(reflections);

    ["question1", "question2", "question3"].forEach((id) => {
      document.getElementById(id).value = "";
    });

    this.renderFullLifeWheel();
    alert("✅ Анализ сохранен!");
  }

  renderReflectionsHistory(reflections) {
    if (reflections.length === 0) {
      return '<p style="text-align: center; padding: 20px; color: #696969;">Анализы отсутствуют</p>';
    }

    return reflections
      .slice(-5)
      .reverse()
      .map(
        (reflection) => `
      <div class="reflection-item">
        <div class="reflection-date">${reflection.date}</div>
        <div class="reflection-preview">${reflection.question1 || "—"}</div>
      </div>
    `
      )
      .join("");
  }
}

// 🚀 ЗАПУСК ПРИЛОЖЕНИЯ
document.addEventListener("DOMContentLoaded", () => {
  console.log("📄 DOM ЗАГРУЖЕН!");
  new ReactLifeWheelApp();
  console.log("✅ ПОЛНЫЙ LIFE WHEEL В REACT УСПЕШНО ЗАПУЩЕН!");
});
